# 圖片上傳指南

本指南說明如何使用專案中的腳本上傳圖片到 Cloudflare R2。

---

## 📋 前置準備

### 1. 配置環境變數

創建 `.env` 文件（如果還沒有）：

```bash
cp .env.example .env
```

編輯 `.env` 文件，填入你的 R2 配置：

```env
# Cloudflare R2 配置
CF_ACCOUNT_ID=你的AccountID
R2_BUCKET=blog-post
R2_BASE_URL=https://your-cdn-domain.com
R2_PREFIX=blog-post

# R2 API 憑證（用於直接上傳）
R2_ACCESS_KEY_ID=你的AccessKeyID
R2_SECRET_ACCESS_KEY=你的SecretAccessKey

# rclone 遠端名稱（用於 rclone 上傳）
RCLONE_REMOTE=r2
```

### 2. 配置 rclone（可選）

如果你要使用 rclone 上傳，需要先配置：

```bash
rclone config
```

按照提示操作：
- **Name**: `r2`
- **Storage**: `s3`
- **Provider**: `Cloudflare`
- **Access Key ID**: 從 Cloudflare R2 API Token 獲取
- **Secret Access Key**: 從 Cloudflare R2 API Token 獲取
- **Region**: `auto`
- **Endpoint**: `https://{你的AccountID}.r2.cloudflarestorage.com`

---

## 🚀 使用方式

### 方法 1：自動處理本地圖片（推薦）

如果你在文章中使用本地圖片路徑（`file://` 或絕對路徑），這個腳本會自動：
1. 轉換為 WebP 格式
2. 壓縮圖片
3. 上傳到 R2
4. 替換文章中的路徑為 CDN URL

**在文章中使用本地路徑：**

```markdown
---
title: "我的文章"
date: 2025-11-01
categories:
  - 技術筆記
---

![圖片說明](file:///path/to/your/image.jpg)
```

**執行腳本：**

```bash
npm run images:process
```

**結果：**
- 圖片會自動上傳到 R2：`blog-post/2025/11/my-article/photo.webp`
- 文章中的路徑會被替換為：`https://your-cdn-domain.com/2025/11/my-article/photo.webp`

**優點：**
- ✅ 自動轉換為 WebP 格式
- ✅ 自動壓縮圖片
- ✅ 自動替換路徑
- ✅ 支援快取，避免重複上傳

---

### 方法 2：手動上傳後更新路徑

如果你已經手動上傳圖片到 R2，可以使用這個腳本更新文章中的圖片路徑。

**1. 手動上傳圖片到 R2：**

```bash
# 使用 rclone 上傳
rclone copy ~/Downloads/ r2:blog-post/2025/11/my-article/ \
  --include "*.{jpg,jpeg,png,webp,gif}" \
  --progress
```

**2. 在文章中使用相對路徑：**

```markdown
---
title: "我的文章"
date: 2025-11-01
categories:
  - 技術筆記
---

![圖片說明](images/photo.jpg)
```

**3. 執行腳本更新路徑：**

```bash
npm run images:update
```

**結果：**
- 文章中的 `images/photo.jpg` 會被替換為：`https://your-cdn-domain.com/blog-post/2025/11/my-article/photo.webp`

**注意：**
- 腳本會自動將圖片路徑轉換為 `.webp` 格式
- 確保 R2 上的圖片檔案名與文章中的一致

---

### 方法 3：使用 rclone 腳本（舊版，適用於 source/_posts/）

如果你使用舊的 `source/_posts/` 目錄結構，可以使用這個腳本：

```bash
npm run images:publish
```

**這個腳本會：**
- 掃描 `source/_posts/` 下的所有文章
- 找到有同名資料夾的文章（包含圖片）
- 上傳圖片到 R2
- 更新文章中的圖片路徑

**注意：** 這個腳本適用於舊的目錄結構，如果你直接在 `content/` 下編輯，請使用方法 1 或 2。

---

## 🔍 驗證圖片

檢查文章中的圖片路徑是否正確：

```bash
npm run images:verify
```

**這個腳本會：**
- 掃描所有文章中的圖片 URL
- 檢查 R2 上是否存在對應的圖片
- 顯示缺失的圖片列表

---

## 📝 完整工作流程範例

### 場景：撰寫新文章並上傳圖片

**1. 創建文章：**

```bash
# 創建文章檔案
content/2025/11/my-new-article.md
```

**2. 在文章中使用本地圖片路徑：**

```markdown
---
title: "我的新文章"
date: 2025-11-01
categories:
  - 技術筆記
coverImage: "file:///path/to/cover.jpg"
---

這是文章內容。

![截圖1](file:///path/to/screenshot1.png)
![截圖2](file:///path/to/screenshot2.png)
```

**3. 執行處理腳本：**

```bash
npm run images:process
```

**輸出範例：**
```
🚀 開始處理本地圖片...

📋 配置：
   內容目錄: /path/to/content
   R2 Bucket: blog-post
   CDN URL: https://your-cdn-domain.com
   快取目錄: /path/to/.image-cache

找到 1 個 Markdown 檔案

📝 處理文章: 2025/11/my-new-article
  找到 3 張本地圖片
  📸 處理中: cover.jpg → cover.webp
  ✅ 已上傳: 2025/11/my-new-article/cover.webp
     原始大小: 245.3 KB
     壓縮後: 89.2 KB (節省 63.6%)
  📸 處理中: screenshot1.png → screenshot1.webp
  ✅ 已上傳: 2025/11/my-new-article/screenshot1.webp
  📸 處理中: screenshot2.png → screenshot2.webp
  ✅ 已上傳: 2025/11/my-new-article/screenshot2.webp
  💾 已更新 Markdown 檔案

✨ 處理完成！

📊 統計資訊：
   處理檔案: 1 個
   處理圖片: 3 張
   跳過圖片: 0 張
   錯誤數量: 0 個

💾 檔案大小：
   原始總大小: 1.23 MB
   壓縮後大小: 0.45 MB
   節省空間: 63.4%
```

**4. 文章中的路徑已自動更新：**

```markdown
---
title: "我的新文章"
date: 2025-11-01
categories:
  - 技術筆記
coverImage: "https://your-cdn-domain.com/2025/11/my-new-article/cover.webp"
---

這是文章內容。

![截圖1](https://your-cdn-domain.com/2025/11/my-new-article/screenshot1.webp)
![截圖2](https://your-cdn-domain.com/2025/11/my-new-article/screenshot2.webp)
```

---

## ⚙️ 腳本說明

### `npm run images:process`

**功能：** 自動處理本地圖片並上傳到 R2

**適用場景：**
- 文章中使用 `file://` 或絕對路徑引用本地圖片
- 需要自動轉換為 WebP 格式
- 需要自動壓縮圖片

**需要的環境變數：**
- `CF_ACCOUNT_ID`
- `R2_ACCESS_KEY_ID`
- `R2_SECRET_ACCESS_KEY`
- `R2_BUCKET`
- `R2_BASE_URL`

---

### `npm run images:update`

**功能：** 更新文章中的圖片路徑為 R2 URL

**適用場景：**
- 已經手動上傳圖片到 R2
- 文章中使用相對路徑（`images/photo.jpg`）
- 需要批量更新路徑

**需要的環境變數：**
- `R2_BASE_URL`
- `R2_PREFIX`

---

### `npm run images:publish`

**功能：** 從 `source/_posts/` 上傳圖片到 R2（舊版）

**適用場景：**
- 使用舊的 `source/_posts/` 目錄結構
- 文章有同名資料夾包含圖片

**需要的環境變數：**
- `CF_ACCOUNT_ID`
- `R2_BUCKET`
- `R2_BASE_URL`
- `R2_PREFIX`
- `RCLONE_REMOTE`

---

### `npm run images:verify`

**功能：** 驗證文章中的圖片路徑是否正確

**適用場景：**
- 檢查圖片是否已上傳到 R2
- 驗證圖片 URL 是否正確

**需要的環境變數：**
- `R2_BASE_URL`
- `R2_PREFIX`
- `R2_BUCKET`
- `RCLONE_REMOTE`

---

## ❓ 常見問題

### Q: 圖片上傳失敗？

A: 
1. 檢查 `.env` 文件中的配置是否正確
2. 確認 R2 API 憑證是否有效
3. 檢查 R2 bucket 是否已啟用 Public Access

### Q: 圖片路徑沒有更新？

A: 
1. 確認圖片路徑格式是否正確（`file://` 或 `images/`）
2. 檢查腳本是否成功執行（查看輸出訊息）
3. 確認文章檔案路徑是否正確（`content/YYYY/MM/`）

### Q: 圖片顯示 404？

A: 
1. 執行 `npm run images:verify` 檢查圖片是否存在
2. 確認 R2 bucket 已啟用 Public Access
3. 檢查圖片 URL 格式是否正確

### Q: 如何手動上傳單張圖片？

A: 
```bash
# 使用 rclone
rclone copy ~/Pictures/photo.jpg r2:blog-post/2025/11/my-article/ --progress

# 然後在文章中使用完整 URL
![圖片](https://your-cdn-domain.com/2025/11/my-article/photo.jpg)
```

---

## 💡 最佳實踐

1. **使用自動處理腳本**：`npm run images:process` 是最方便的方式
2. **使用 WebP 格式**：腳本會自動轉換，減小檔案大小
3. **定期驗證**：使用 `npm run images:verify` 檢查圖片是否正確
4. **使用快取**：腳本會自動快取已處理的圖片，避免重複上傳

---

**記住：** 圖片上傳後，記得提交文章檔案的更改到 Git！

